<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWCC Classroom Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        // Custom palette if needed
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        
        /* Remove number arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Seating Grid */
        .seating-grid { display: grid; gap: 12px; padding: 20px; justify-content: center; }
        .seat { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .seat:active { transform: scale(0.95); }
        .seat-walkway { background: transparent; border: 2px dashed rgba(203, 213, 225, 0.4); pointer-events: none; }
        .seat-walkway.editing { pointer-events: auto; border-color: #94a3b8; }

        /* Glass effect for modals - Removed background color to prevent white-on-white issue */
        .glass-modal { backdrop-filter: blur(4px); }
        
        /* Sidebar transition */
        #mainSidebar { transition: width 0.3s ease, transform 0.3s ease; }
        .sidebar-collapsed { width: 0 !important; overflow: hidden; }

        /* Full Screen Overrides */
        :fullscreen { background-color: #f8fafc; overflow-y: auto; }
        :fullscreen #summaryContainer { padding: 40px; max-width: 100%; height: 100%; border-radius: 0; }
        :fullscreen th { font-size: 1.25rem; padding: 20px; }
        :fullscreen td { font-size: 1.125rem; padding: 20px; }
        :fullscreen .fs-hide { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] flex overflow-hidden selection:bg-indigo-100 selection:text-indigo-700">

    <!-- MOBILE OVERLAY -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-30 hidden md:hidden transition-opacity"></div>

    <!-- SIDEBAR -->
    <aside id="mainSidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-100 flex flex-col shadow-2xl md:shadow-none transform -translate-x-full md:translate-x-0 md:static whitespace-nowrap">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200 shrink-0">
                    <i class="ph ph-chalkboard-teacher text-xl"></i>
                </div>
                <div class="overflow-hidden">
                    <h1 class="font-bold text-slate-800 text-lg leading-tight">Classroom</h1>
                    <p class="text-[10px] font-bold text-indigo-500 tracking-wider uppercase">Manager</p>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden ml-auto text-slate-400 hover:text-slate-600">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
        </div>

        <div class="px-4 mb-2">
            <button onclick="openModal('classModal')" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-medium py-3 px-4 rounded-xl transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2 group overflow-hidden">
                <i class="ph ph-plus-circle text-lg group-hover:scale-110 transition-transform"></i>
                <span>New Class</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-4 pb-4 space-y-1 mt-2" id="classList">
            <!-- Class items injected here -->
        </div>

        <!-- Data Management Section -->
        <div class="p-4 border-t border-slate-100 bg-slate-50/50">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="exportData()" class="text-xs font-medium text-slate-600 hover:text-indigo-600 bg-white hover:bg-indigo-50 py-2.5 rounded-lg border border-slate-200 shadow-sm transition-all flex flex-col items-center justify-center gap-1">
                    <i class="ph ph-download-simple text-lg"></i> Backup
                </button>
                <button onclick="openModal('importModal')" class="text-xs font-medium text-slate-600 hover:text-indigo-600 bg-white hover:bg-indigo-50 py-2.5 rounded-lg border border-slate-200 shadow-sm transition-all flex flex-col items-center justify-center gap-1">
                    <i class="ph ph-upload-simple text-lg"></i> Restore
                </button>
            </div>
            <button onclick="askClearAllData()" class="text-[10px] font-bold text-slate-400 hover:text-red-500 w-full text-center py-2 mt-2 transition-colors uppercase tracking-wide">
                Reset All Data
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative w-full">
        
        <!-- HEADER (Shared Mobile/Desktop) -->
        <div class="bg-white border-b border-slate-100 px-4 py-3 flex items-center justify-between shrink-0 z-20 sticky top-0 h-16">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="text-slate-500 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-100 transition-colors">
                    <i class="ph ph-list text-2xl"></i>
                </button>
                <div class="flex flex-col md:hidden">
                    <span id="mobileHeaderTitle" class="font-bold text-slate-800 text-lg truncate">Overview</span>
                    <span id="mobileHeaderSubtitle" class="text-xs text-slate-500 font-medium hidden"></span>
                </div>
            </div>
            <div id="mobileHeaderActions"></div> 
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-0">
            <div class="w-32 h-32 bg-white rounded-3xl flex items-center justify-center mb-6 text-indigo-300 shadow-[0_8px_30px_rgb(0,0,0,0.04)]">
                <i class="ph ph-chalkboard text-6xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Welcome Back</h2>
            <p class="text-slate-500 max-w-sm mb-8">Select a class from the menu to start managing your students, grades, and schedules.</p>
            
            <div class="flex flex-col md:flex-row gap-3 w-full max-w-xs md:max-w-md justify-center">
                <button onclick="toggleSidebar()" class="md:hidden bg-white text-slate-700 border border-slate-200 hover:border-indigo-300 hover:text-indigo-600 font-medium py-3 px-6 rounded-xl shadow-sm transition-all w-full flex items-center justify-center gap-2">
                    <i class="ph ph-list text-lg"></i> Open Menu
                </button>
                <button onclick="loadDemoData()" class="bg-gradient-to-r from-indigo-500 to-violet-500 hover:from-indigo-600 hover:to-violet-600 text-white font-medium py-3 px-6 rounded-xl shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2 w-full md:w-auto">
                    <i class="ph ph-magic-wand text-lg"></i> Load Demo Class
                </button>
            </div>
        </div>

        <!-- Class Dashboard -->
        <div id="classDashboard" class="hidden flex-col h-full z-10 fade-in">
            
            <!-- Desktop Header -->
            <header class="hidden md:flex bg-white border-b border-slate-100 px-8 py-6 justify-between items-center sticky top-0 z-20">
                <div>
                    <h2 id="currentClassName" class="text-3xl font-bold text-slate-800 tracking-tight">Mathematics 101</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="px-2 py-0.5 rounded-md bg-green-100 text-green-700 text-xs font-bold uppercase tracking-wide" id="studentCountBadge">0 Students</span>
                    </div>
                </div>
                <div>
                    <button onclick="askDeleteCurrentClass()" class="text-slate-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors" title="Delete Class">
                        <i class="ph ph-trash text-xl"></i>
                    </button>
                </div>
            </header>

            <!-- Tabs -->
            <div class="bg-white border-b border-slate-100 px-4 md:px-8">
                <div class="flex space-x-1 md:space-x-2 overflow-x-auto scrollbar-hide py-1">
                    <button id="tabStudents" onclick="switchTab('students')" class="px-4 py-3 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 hover:text-indigo-600 transition-all flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent">
                        <i class="ph ph-users text-lg"></i> Students
                    </button>
                    <button id="tabGradebook" onclick="switchTab('gradebook')" class="px-4 py-3 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 hover:text-emerald-600 transition-all flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent">
                        <i class="ph ph-exam text-lg"></i> Gradebook
                    </button>
                    <button id="tabTracker" onclick="switchTab('tracker')" class="px-4 py-3 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 hover:text-rose-600 transition-all flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent">
                        <i class="ph ph-check-square-offset text-lg"></i> Materials
                    </button>
                    <button id="tabHomework" onclick="switchTab('homework')" class="px-4 py-3 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 hover:text-amber-600 transition-all flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent">
                        <i class="ph ph-notebook text-lg"></i> Homework
                    </button>
                     <button id="tabSeating" onclick="switchTab('seating')" class="px-4 py-3 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 hover:text-violet-600 transition-all flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent">
                        <i class="ph ph-chair text-lg"></i> Seating
                    </button>
                    <button id="tabSummary" onclick="switchTab('summary')" class="px-4 py-3 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent">
                        <i class="ph ph-presentation-chart text-lg"></i> Summary
                    </button>
                </div>
            </div>

            <!-- CONTENT AREA -->
            <div class="flex-1 overflow-hidden relative bg-slate-50">
                
                <!-- 1. STUDENTS TAB -->
                <div id="viewStudents" class="absolute inset-0 overflow-y-auto p-4 md:p-8">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">Student Roster</h3>
                                <p class="text-sm text-slate-500">Manage class list and details.</p>
                            </div>
                            <div class="flex gap-3 w-full sm:w-auto">
                                <button onclick="openModal('importStudentModal')" class="flex-1 sm:flex-none justify-center text-slate-600 bg-white border border-slate-200 hover:border-green-500 hover:text-green-700 shadow-sm px-4 py-2.5 rounded-xl font-medium text-sm transition-all flex items-center gap-2">
                                    <i class="ph ph-microsoft-excel-logo text-green-600 text-lg"></i> <span class="hidden sm:inline">Import from Excel</span><span class="sm:hidden">Import</span>
                                </button>
                                <button onclick="openModal('studentModal')" class="flex-1 sm:flex-none justify-center text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-200 px-4 py-2.5 rounded-xl font-medium text-sm transition-all flex items-center gap-2">
                                    <i class="ph ph-user-plus text-lg"></i> Add
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse min-w-[600px]">
                                    <thead class="bg-slate-50/50 border-b border-slate-100 text-xs uppercase font-semibold text-slate-500 tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4 w-24">Class</th>
                                            <th class="px-6 py-4 w-20">No.</th>
                                            <th class="px-6 py-4">Name</th>
                                            <th class="px-6 py-4">ID / Reg No.</th>
                                            <th class="px-6 py-4 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentListBody" class="divide-y divide-slate-50 text-sm">
                                        <!-- Injected -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noStudentsMsg" class="p-16 text-center flex flex-col items-center justify-center">
                                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3 text-slate-300">
                                    <i class="ph ph-users-three text-3xl"></i>
                                </div>
                                <p class="text-slate-400 font-medium">No students added yet.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. GRADEBOOK TAB -->
                <div id="viewGradebook" class="absolute inset-0 hidden flex-col">
                    <div class="px-4 md:px-8 py-4 border-b border-slate-200 bg-white flex justify-between items-center z-10 shadow-sm">
                         <div>
                            <h3 class="font-bold text-slate-800 text-sm md:text-base">Gradebook</h3>
                        </div>
                        <button onclick="openModal('assignmentModal')" class="bg-emerald-50 text-emerald-700 hover:bg-emerald-100 hover:text-emerald-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="ph ph-plus-circle text-lg"></i> <span class="hidden sm:inline">New Assignment</span><span class="sm:hidden">New</span>
                        </button>
                    </div>
                    <div class="flex-1 overflow-auto bg-slate-50">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-white sticky top-0 z-10 shadow-sm text-xs text-slate-500 uppercase font-semibold">
                                <tr id="gradebookHeaderRow">
                                    <!-- Injected -->
                                </tr>
                            </thead>
                            <tbody id="gradebookBody" class="text-sm divide-y divide-slate-100 bg-white">
                                <!-- Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3. TRACKER TAB -->
                <div id="viewTracker" class="absolute inset-0 hidden overflow-y-auto flex-col md:flex-row p-4 md:p-6 gap-6">
                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 p-5 md:p-6 shrink-0">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <span class="p-1.5 bg-rose-100 text-rose-600 rounded-lg"><i class="ph ph-calendar-check text-lg"></i></span> 
                                    Attendance
                                </h3>
                                <p class="text-xs text-slate-500 mt-1 ml-1">Log missing materials.</p>
                            </div>
                            <div class="flex gap-2 w-full sm:w-auto bg-slate-50 p-1 rounded-xl border border-slate-100">
                                <button onclick="changeMonth(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg text-slate-500 transition-all"><i class="ph ph-caret-left"></i></button>
                                <span id="calendarMonthLabel" class="text-sm font-bold px-2 w-32 text-center flex items-center justify-center text-slate-700">Oct 2023</span>
                                <button onclick="changeMonth(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg text-slate-500 transition-all"><i class="ph ph-caret-right"></i></button>
                            </div>
                            <button onclick="openModal('scheduleModal')" class="sm:ml-2 text-sm bg-white border border-slate-200 hover:border-indigo-300 text-slate-600 px-3 py-2 rounded-lg transition-colors flex items-center justify-center gap-2 w-full sm:w-auto shadow-sm">
                                <i class="ph ph-gear"></i> Schedule
                            </button>
                        </div>
                        <div class="border border-slate-100 rounded-xl overflow-hidden shadow-sm w-full">
                            <div class="w-full overflow-x-auto"> 
                                <div class="min-w-[300px] md:min-w-0">
                                    <div class="calendar-grid bg-slate-50 border-b border-slate-100 text-[10px] uppercase font-bold text-slate-400 text-center py-3 tracking-wider">
                                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                                    </div>
                                    <div id="calendarGrid" class="calendar-grid bg-white"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Stats -->
                    <div class="w-full md:w-80 bg-white rounded-2xl shadow-sm border border-slate-200 p-5 flex flex-col shrink-0 min-h-[300px]">
                        <h3 class="text-lg font-bold text-slate-800 mb-1 flex items-center gap-2">
                             <i class="ph ph-warning-circle text-rose-500"></i> Missing Log
                        </h3>
                        <p class="text-xs text-slate-400 mb-4 border-b border-slate-100 pb-3">Click to view details</p>
                        <div class="flex-1 overflow-y-auto pr-1 max-h-[400px] md:max-h-none">
                            <table class="w-full text-sm"><tbody id="trackerStatsBody"></tbody></table>
                            <div id="noTrackerStats" class="text-center text-slate-400 text-sm mt-10 italic">All clear!</div>
                        </div>
                    </div>
                </div>

                <!-- 4. HOMEWORK TAB -->
                <div id="viewHomework" class="absolute inset-0 hidden overflow-hidden flex-col">
                    <div class="px-6 py-3 bg-white border-b border-slate-200 flex gap-4 z-10 sticky top-0 overflow-x-auto scrollbar-hide">
                        <button id="hwSubTabStream" onclick="switchHwSubTab('stream')" class="px-4 py-2 rounded-full text-sm font-bold bg-amber-50 text-amber-700 transition-colors flex items-center gap-2 whitespace-nowrap">
                            <i class="ph ph-list-dashes"></i> Assignments
                        </button>
                        <button id="hwSubTabReport" onclick="switchHwSubTab('report')" class="px-4 py-2 rounded-full text-sm font-bold text-slate-500 hover:bg-slate-50 transition-colors flex items-center gap-2 whitespace-nowrap">
                            <i class="ph ph-chart-bar"></i> Penalty Report
                        </button>
                    </div>

                    <div class="flex-1 relative overflow-hidden">
                        <!-- Stream View -->
                        <div id="hwStreamView" class="absolute inset-0 flex flex-col md:flex-row p-4 md:p-6 gap-6 overflow-y-auto md:overflow-hidden">
                            <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 p-5 md:p-6 min-h-[300px]">
                                <div class="flex justify-between items-center mb-6">
                                    <div>
                                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                            <span class="p-1.5 bg-amber-100 text-amber-600 rounded-lg"><i class="ph ph-notebook text-lg"></i></span>
                                            Homework Stream
                                        </h3>
                                    </div>
                                    <button onclick="openModal('homeworkModal')" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-xl font-medium text-sm transition-all shadow-md shadow-amber-200 flex items-center gap-2">
                                        <i class="ph ph-plus-circle text-lg"></i> <span class="hidden sm:inline">New Homework</span><span class="sm:hidden">New</span>
                                    </button>
                                </div>
                                <div class="flex-1 overflow-y-auto pr-2 space-y-3" id="homeworkList"></div>
                                <div id="noHomeworkMsg" class="hidden text-center text-slate-400 mt-10 italic">No homework assigned yet.</div>
                            </div>
                            <div class="w-full md:w-80 bg-white rounded-2xl shadow-sm border border-slate-200 p-5 flex flex-col h-64 md:h-auto">
                                <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3">Penalty Summary</h3>
                                <div class="flex-1 overflow-y-auto pr-1"><table class="w-full text-sm"><tbody id="homeworkStatsBody"></tbody></table><div id="noHomeworkStats" class="text-center text-slate-400 text-sm mt-10 italic">No penalties recorded.</div></div>
                            </div>
                        </div>

                        <!-- Report View -->
                        <div id="hwReportView" class="absolute inset-0 hidden p-4 md:p-6 overflow-auto">
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-w-[600px]">
                                <table class="w-full text-left border-collapse"><thead id="hwReportHeader" class="bg-slate-50"></thead><tbody id="hwReportBody" class="text-sm divide-y divide-slate-100"></tbody></table>
                                <div id="noHwReportMsg" class="hidden p-12 text-center text-slate-400 italic">No data available.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. SEATING TAB -->
                <div id="viewSeating" class="absolute inset-0 hidden overflow-hidden flex-col">
                     <div class="px-6 py-4 border-b border-slate-200 bg-white flex flex-col md:flex-row justify-between items-start md:items-center gap-4 shadow-sm z-10">
                         <div>
                             <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                 <span class="p-1.5 bg-violet-100 text-violet-600 rounded-lg"><i class="ph ph-chair text-lg"></i></span>
                                 Seating Plan
                             </h3>
                         </div>
                         <div class="flex flex-wrap gap-2 items-center bg-slate-50 p-1 rounded-xl border border-slate-100">
                             <div class="flex items-center px-3 py-1 gap-2 border-r border-slate-200">
                                 <label class="text-xs font-bold text-slate-400">R:</label><input type="number" id="seatRows" class="w-8 text-center outline-none text-sm font-bold bg-transparent" value="5" min="1" max="10">
                                 <label class="text-xs font-bold text-slate-400">C:</label><input type="number" id="seatCols" class="w-8 text-center outline-none text-sm font-bold bg-transparent" value="6" min="1" max="10">
                             </div>
                             <button onclick="updateSeatingGrid()" class="text-xs font-bold text-slate-600 hover:text-indigo-600 px-3 py-1.5 rounded-lg transition-colors">Resize</button>
                             <button onclick="toggleEditSeating()" id="btnEditSeat" class="text-xs bg-white border border-slate-200 hover:border-violet-300 text-slate-700 hover:text-violet-600 px-4 py-1.5 rounded-lg shadow-sm flex items-center gap-2 transition-all"><i class="ph ph-pencil-simple"></i> Edit</button>
                         </div>
                     </div>
                     <div class="flex-1 overflow-auto bg-slate-50/50 relative p-8 flex items-center justify-center">
                         <div id="seatingContainer" class="bg-white shadow-xl shadow-slate-200/50 border border-slate-200 rounded-3xl overflow-hidden relative"><div id="seatingGrid" class="seating-grid"></div></div>
                     </div>
                </div>

                <!-- 6. SUMMARY TAB (NEW) -->
                <div id="viewSummary" class="absolute inset-0 hidden overflow-hidden flex-col bg-slate-50">
                     <div class="px-6 py-4 border-b border-slate-200 bg-white flex justify-between items-center shadow-sm z-10 fs-hide">
                         <div>
                             <h3 class="font-bold text-slate-800 flex items-center gap-2 text-xl">
                                 <span class="p-1.5 bg-blue-100 text-blue-600 rounded-lg"><i class="ph ph-presentation text-lg"></i></span>
                                 Class Summary
                             </h3>
                             <p class="text-xs text-slate-500 mt-1 ml-10">Combined records for projection.</p>
                         </div>
                         <button onclick="toggleSummaryFullScreen()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-md transition-all flex items-center gap-2">
                             <i class="ph ph-arrows-out-simple"></i> Full Screen
                         </button>
                     </div>
                     <div class="flex-1 overflow-auto p-6 md:p-8" id="summaryContainer">
                         <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden h-full flex flex-col">
                             <div class="overflow-y-auto flex-1">
                                 <table class="w-full text-left">
                                     <thead class="bg-slate-50 border-b border-slate-100 sticky top-0 z-10">
                                         <tr>
                                             <th class="px-8 py-5 text-sm font-bold text-slate-500 uppercase tracking-wider w-1/3">Student</th>
                                             <th class="px-8 py-5 text-sm font-bold text-slate-500 uppercase tracking-wider text-center text-amber-600">Homework Penalties</th>
                                             <th class="px-8 py-5 text-sm font-bold text-slate-500 uppercase tracking-wider text-center text-rose-600">Missing Materials</th>
                                             <th class="px-8 py-5 text-sm font-bold text-slate-800 uppercase tracking-wider text-right">Total Infractions</th>
                                         </tr>
                                     </thead>
                                     <tbody id="summaryBody" class="divide-y divide-slate-50 text-base">
                                         <!-- Injected -->
                                     </tbody>
                                 </table>
                             </div>
                             <div id="noSummaryMsg" class="p-20 text-center text-slate-400 text-lg italic hidden">No students found.</div>
                         </div>
                     </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODALS -->
    <!-- Confirmation -->
    <div id="confirmModal" class="fixed inset-0 bg-slate-900/40 z-[60] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl shadow-2xl w-80 p-6 m-4 text-center transform scale-100 transition-all"><div class="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="ph ph-warning text-2xl"></i></div><h3 class="text-lg font-bold text-slate-800" id="confirmTitle">Confirm</h3><p class="text-sm text-slate-500 mt-2 mb-6" id="confirmMessage">Are you sure?</p><div class="flex justify-center gap-3"><button onclick="closeModal('confirmModal')" class="text-slate-500 hover:bg-slate-50 px-4 py-2.5 rounded-xl text-sm font-medium transition-colors">Cancel</button><button id="confirmBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2.5 rounded-xl text-sm font-medium shadow-lg shadow-red-200 transition-all">Confirm</button></div></div></div>

    <!-- Alert -->
    <div id="alertModal" class="fixed inset-0 bg-slate-900/40 z-[60] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl shadow-2xl w-80 p-6 m-4 text-center"><div class="w-12 h-12 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="ph ph-info text-2xl"></i></div><h3 class="text-lg font-bold text-slate-800" id="alertTitle">Notice</h3><p class="text-sm text-slate-500 mt-2 mb-6" id="alertMessage">Done.</p><button onclick="closeModal('alertModal')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl text-sm font-medium shadow-lg shadow-indigo-200 transition-all w-full">Okay</button></div></div>

    <!-- Generic Input Modals (Class, Student, HW, etc.) - Simplified styling -->
    <!-- Add Class -->
    <div id="classModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-96 p-6 m-4 shadow-2xl"><h3 class="text-lg font-bold text-slate-800 mb-4">Create New Class</h3><input id="newClassName" class="w-full border border-slate-200 bg-slate-50 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none mb-6" placeholder="e.g. Science 101"><div class="flex justify-end gap-2"><button onclick="closeModal('classModal')" class="text-slate-500 px-4 py-2 hover:bg-slate-50 rounded-lg text-sm font-medium">Cancel</button><button onclick="addClass()" class="bg-indigo-600 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md hover:shadow-lg transition-all">Create</button></div></div></div>
    
    <!-- Add Student -->
    <div id="studentModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-96 p-6 m-4 shadow-2xl"><h3 class="text-lg font-bold text-slate-800 mb-4">Add Student</h3><div class="space-y-3"><div class="flex gap-3"><div class="w-1/3"><label class="text-[10px] font-bold text-slate-400 uppercase">Class</label><input id="newStudentClass" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500"></div><div class="w-1/3"><label class="text-[10px] font-bold text-slate-400 uppercase">No.</label><input id="newStudentNo" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500"></div></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Full Name</label><input id="newStudentName" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500"></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">ID (Optional)</label><input id="newStudentID" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500"></div></div><div class="flex justify-end gap-2 mt-6"><button onclick="closeModal('studentModal')" class="text-slate-500 px-4 py-2 hover:bg-slate-50 rounded-lg text-sm font-medium">Cancel</button><button onclick="addStudent()" class="bg-indigo-600 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md">Add</button></div></div></div>

    <!-- Import Excel -->
    <div id="importStudentModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-full max-w-2xl p-6 m-4 shadow-2xl"><h3 class="text-lg font-bold text-slate-800 mb-2">Import from Excel</h3><p class="text-xs text-slate-500 mb-4 font-mono bg-slate-100 p-2 rounded">Format: Class | No | Name | Name | ID</p><textarea id="importStudentText" class="w-full h-48 border border-slate-200 bg-slate-50 rounded-xl p-4 text-xs font-mono focus:ring-2 focus:ring-green-500 outline-none mb-4" placeholder="Paste cells here..."></textarea><div class="flex justify-end gap-3"><button onclick="closeModal('importStudentModal')" class="text-slate-500 px-4 py-2 hover:bg-slate-50 rounded-lg text-sm font-medium">Cancel</button><button onclick="importStudentsFromText()" class="bg-green-600 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md">Import Students</button></div></div></div>

    <!-- Add Assignment -->
    <div id="assignmentModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-96 p-6 m-4 shadow-2xl"><h3 class="text-lg font-bold text-slate-800 mb-4">New Grade Item</h3><div class="space-y-4"><div><label class="text-[10px] font-bold text-slate-400 uppercase">Title</label><input id="assignName" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-emerald-500"></div><div class="flex gap-3"><div class="w-1/2"><label class="text-[10px] font-bold text-slate-400 uppercase">Max Points</label><input type="number" id="assignMax" value="100" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-emerald-500"></div><div class="w-1/2"><label class="text-[10px] font-bold text-slate-400 uppercase">Type</label><select id="assignType" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none"><option>Assignment</option><option>Quiz</option><option>Exam</option></select></div></div></div><div class="flex justify-end gap-2 mt-6"><button onclick="closeModal('assignmentModal')" class="text-slate-500 px-4 py-2 hover:bg-slate-50 rounded-lg text-sm font-medium">Cancel</button><button onclick="addAssignment()" class="bg-emerald-600 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md">Create</button></div></div></div>

    <!-- Create Homework -->
    <div id="homeworkModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-96 p-6 m-4 shadow-2xl"><h3 class="text-lg font-bold text-slate-800 mb-4">Assign Homework</h3><div class="space-y-4"><div><label class="text-[10px] font-bold text-slate-400 uppercase">Task Description</label><input id="hwTitle" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-amber-500"></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Due Date</label><input type="date" id="hwDate" class="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-amber-500 text-slate-600"></div></div><div class="flex justify-end gap-2 mt-6"><button onclick="closeModal('homeworkModal')" class="text-slate-500 px-4 py-2 hover:bg-slate-50 rounded-lg text-sm font-medium">Cancel</button><button onclick="addHomework()" class="bg-amber-500 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md">Assign</button></div></div></div>

    <!-- Check Homework -->
    <div id="homeworkCheckModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-full max-w-2xl flex flex-col max-h-[85vh] m-4 shadow-2xl"><div class="p-6 border-b border-slate-100 flex justify-between items-center"><div class="flex flex-col"><h3 class="text-xl font-bold text-slate-800" id="hwCheckTitle">Homework</h3><div class="flex gap-4 mt-1 text-xs font-medium"><span class="flex items-center gap-1 text-green-600"><i class="ph ph-check-circle-fill"></i> Tick = Done</span><span class="flex items-center gap-1 text-red-500"><i class="ph ph-flag-fill"></i> Flag = Penalty</span></div></div><div class="flex gap-2 bg-slate-100 p-1 rounded-xl"><button onclick="setHwView('list')" id="btnHwList" class="px-4 py-1.5 text-xs font-bold rounded-lg shadow-sm bg-white text-slate-800">List</button><button onclick="setHwView('seat')" id="btnHwSeat" class="px-4 py-1.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700">Seating</button></div></div><div class="flex-1 overflow-y-auto p-6 bg-slate-50"><div id="hwStudentList" class="space-y-2"></div><div id="hwSeatContainer" class="hidden flex justify-center"><div id="hwSeatGrid" class="seating-grid"></div></div><div id="hwEmptyState" class="hidden p-8 text-center text-slate-400">No students.</div></div><div class="p-4 border-t border-slate-100 flex justify-between items-center bg-white"><button onclick="askDeleteHomework()" class="text-red-400 hover:text-red-600 text-xs font-bold uppercase flex items-center gap-1 px-2"><i class="ph ph-trash"></i> Delete Task</button><div class="flex gap-3"><button onclick="flagAllUnticked()" class="text-red-600 bg-red-50 border border-red-200 hover:bg-red-100 px-4 py-2 rounded-xl text-xs font-bold transition-colors flex items-center gap-2 uppercase tracking-wide"><i class="ph ph-flag"></i> Flag Unticked</button><button id="markAllBtn" onclick="markAllHomeworkDone()" class="text-indigo-600 bg-indigo-50 border border-indigo-100 hover:bg-indigo-100 px-4 py-2 rounded-xl text-xs font-bold transition-colors flex items-center gap-2 uppercase tracking-wide"><i id="markAllIcon" class="ph ph-checks"></i> <span id="markAllText">Mark All Done</span></button><button onclick="closeModal('homeworkCheckModal')" class="bg-slate-800 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md">Done</button></div></div></div></div>

    <!-- Check Material (Calendar) -->
    <div id="dayLogModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-full max-w-2xl flex flex-col max-h-[85vh] m-4 shadow-2xl"><div class="p-6 border-b border-slate-100 flex justify-between items-center"><div class="flex flex-col"><h3 class="text-xl font-bold text-slate-800" id="logModalDateTitle">Date</h3><p class="text-xs text-rose-500 font-bold uppercase mt-1">Select missing students</p></div><div class="flex gap-2 bg-slate-100 p-1 rounded-xl"><button onclick="setMatView('list')" id="btnMatList" class="px-4 py-1.5 text-xs font-bold rounded-lg shadow-sm bg-white text-slate-800">List</button><button onclick="setMatView('seat')" id="btnMatSeat" class="px-4 py-1.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700">Seating</button></div></div><div class="flex-1 overflow-y-auto p-6 bg-slate-50"><div id="logStudentList" class="space-y-2"></div><div id="logSeatContainer" class="hidden flex justify-center"><div id="logSeatGrid" class="seating-grid"></div></div><div id="logEmptyState" class="hidden p-8 text-center text-slate-400">No students.</div></div><div class="p-4 border-t border-slate-100 flex justify-end gap-2 bg-white"><button onclick="closeModal('dayLogModal')" class="text-slate-500 px-4 py-2 hover:bg-slate-50 rounded-lg text-sm font-medium">Cancel</button><button onclick="saveDayLog()" class="bg-rose-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md">Save Log</button></div></div></div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal">
        <div class="bg-white rounded-2xl w-96 p-6 m-4 shadow-2xl">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Class Schedule</h3>
            <p class="text-xs text-slate-500 mb-4">Select the days this class meets weekly.</p>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <!-- Checkboxes -->
                <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded border border-slate-200">
                    <input type="checkbox" class="schedule-day-check text-indigo-600 rounded focus:ring-indigo-500" value="1"> <span class="text-sm font-bold text-slate-600">Monday</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded border border-slate-200">
                    <input type="checkbox" class="schedule-day-check text-indigo-600 rounded focus:ring-indigo-500" value="2"> <span class="text-sm font-bold text-slate-600">Tuesday</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded border border-slate-200">
                    <input type="checkbox" class="schedule-day-check text-indigo-600 rounded focus:ring-indigo-500" value="3"> <span class="text-sm font-bold text-slate-600">Wednesday</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded border border-slate-200">
                    <input type="checkbox" class="schedule-day-check text-indigo-600 rounded focus:ring-indigo-500" value="4"> <span class="text-sm font-bold text-slate-600">Thursday</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded border border-slate-200">
                    <input type="checkbox" class="schedule-day-check text-indigo-600 rounded focus:ring-indigo-500" value="5"> <span class="text-sm font-bold text-slate-600">Friday</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded border border-slate-200">
                    <input type="checkbox" class="schedule-day-check text-indigo-600 rounded focus:ring-indigo-500" value="6"> <span class="text-sm font-bold text-slate-600">Saturday</span>
                </label>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('scheduleModal')" class="text-slate-500 px-4 py-2 hover:bg-slate-50 rounded-lg text-sm font-medium">Cancel</button>
                <button onclick="saveSchedule()" class="bg-indigo-600 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md">Save Schedule</button>
            </div>
        </div>
    </div>

    <!-- Penalty Detail -->
    <div id="penaltyDetailModal" class="fixed inset-0 bg-slate-900/40 z-[60] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-80 p-6 m-4 text-center shadow-2xl"><div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-600 shadow-sm"><i class="ph ph-flag text-3xl"></i></div><h3 class="text-lg font-bold text-slate-800" id="penaltyStudentName">Student</h3><p class="text-xs text-slate-400 uppercase font-bold tracking-wide mt-1" id="penaltyHomeworkTitle">HW</p><div class="flex justify-center items-center gap-6 my-8"><button onclick="adjustPenaltyCount(-1)" class="w-10 h-10 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors"><i class="ph ph-minus text-lg"></i></button><span class="text-4xl font-bold text-slate-800" id="penaltyCountDisplay">0</span><button onclick="adjustPenaltyCount(1)" class="w-10 h-10 bg-amber-100 hover:bg-amber-200 rounded-full text-amber-600 transition-colors"><i class="ph ph-plus text-lg"></i></button></div><button onclick="savePenaltyDetail()" class="bg-slate-800 text-white px-4 py-3 rounded-xl w-full font-bold shadow-md">Save Record</button></div></div>

    <!-- Material Details -->
    <div id="materialDetailsModal" class="fixed inset-0 bg-slate-900/40 z-[60] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-80 p-6 m-4 shadow-2xl"><div class="text-center mb-6"><div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-3 text-rose-500"><i class="ph ph-calendar-x text-2xl"></i></div><h3 class="font-bold text-slate-800 text-lg" id="materialStudentName">Student</h3><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Missing History</p></div><div id="materialDatesList" class="max-h-60 overflow-y-auto bg-slate-50 p-2 rounded-xl mb-4 text-xs space-y-1"></div><button onclick="closeModal('materialDetailsModal')" class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 px-4 py-2.5 rounded-xl w-full font-bold">Close</button></div></div>

    <!-- Seat Assign -->
    <div id="seatAssignModal" class="fixed inset-0 bg-slate-900/40 z-[60] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-80 p-5 m-4 shadow-2xl"><h3 class="font-bold text-slate-800 mb-4 text-lg">Assign Seat</h3><div class="space-y-1 mb-4 max-h-60 overflow-y-auto pr-1" id="seatStudentList"></div><div class="flex flex-col gap-2 pt-2 border-t border-slate-100"><button onclick="assignSeatValue('walkway')" class="text-xs font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 py-3 border-2 border-dashed border-slate-200 rounded-xl">Mark as Walkway</button><button onclick="assignSeatValue(null)" class="text-xs font-bold text-red-500 hover:bg-red-50 py-3 rounded-xl">Clear Seat</button><button onclick="closeModal('seatAssignModal')" class="text-xs font-bold text-slate-400 hover:text-slate-600 py-2">Cancel</button></div></div></div>
    
    <!-- Restore Modal -->
    <div id="importModal" class="fixed inset-0 bg-slate-900/40 z-[55] hidden flex items-center justify-center glass-modal"><div class="bg-white rounded-2xl w-[500px] p-8 m-4 shadow-2xl"><h3 class="text-xl font-bold text-slate-800 mb-2">Restore Backup</h3><p class="text-sm text-slate-500 mb-6">Paste your backup code below to restore data.</p><textarea id="importText" class="w-full h-32 border border-slate-200 bg-slate-50 rounded-xl p-4 text-xs font-mono mb-6 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Paste JSON code here..."></textarea><div class="flex gap-3"><button onclick="closeModal('importModal')" class="flex-1 text-slate-500 bg-white border border-slate-200 hover:bg-slate-50 py-3 rounded-xl font-bold text-sm">Cancel</button><button onclick="importDataText()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold text-sm shadow-md">Restore Data</button></div></div></div>

    <script>
        // --- APP STATE & STORAGE ---
        let appData = { classes: [], selectedClassId: null };
        let currentCalendarDate = new Date();
        let selectedLogDate = null; 
        let selectedHomeworkId = null; 
        let currentHwTab = 'stream'; 
        let pendingConfirmAction = null; 
        let selectedPenaltyStudentId = null;
        let tempPenaltyCount = 0;
        let isSeatingEditMode = false;
        let selectedSeatCoords = null; 
        let activeHwView = 'list'; 
        let activeMatView = 'list'; 

        // --- LOCAL STORAGE INIT ---
        function loadData() {
            const saved = localStorage.getItem('teacherAppData');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    // Data Migration / Integrity Check
                    if(!appData.classes) appData.classes = [];
                    appData.classes.forEach(c => {
                        if (!c.schedule) c.schedule = []; 
                        if (!c.materialLog) c.materialLog = {}; 
                        if (!c.homeworks) c.homeworks = []; 
                        if (!c.seating) c.seating = { rows: 5, cols: 6, layout: {} };
                        c.homeworks.forEach(hw => {
                            if(!hw.penalties) hw.penalties = {};
                        });
                    });
                } catch(e) {
                    console.error("Data parse error", e);
                    appData = { classes: [], selectedClassId: null };
                }
            }
            renderClassList();
            if (appData.selectedClassId) {
                renderClassView(appData.selectedClassId);
            } else {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('classDashboard').classList.add('hidden');
            }
        }

        function saveData() {
            localStorage.setItem('teacherAppData', JSON.stringify(appData));
        }

        // --- CORE LOGIC ---
        function sortClassStudents(cls) {
            cls.students.sort((a, b) => {
                const classA = (a.classLabel || "").toString().trim();
                const classB = (b.classLabel || "").toString().trim();
                const cmp = classA.localeCompare(classB, undefined, { numeric: true, sensitivity: 'base' });
                if (cmp !== 0) return cmp;
                const numA = parseInt(a.classNo);
                const numB = parseInt(b.classNo);
                if (!isNaN(numA) && !isNaN(numB)) {
                    if (numA !== numB) return numA - numB;
                }
                return (a.classNo || "").toString().localeCompare((b.classNo || "").toString(), undefined, { numeric: true });
            });
        }

        function toggleSidebar() {
            const sb = document.getElementById('mainSidebar');
            const ov = document.getElementById('sidebarOverlay');
            if(window.innerWidth >= 768) { sb.classList.toggle('hidden'); ov.classList.add('hidden'); }
            else { 
                if(sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
                else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
            }
        }
        window.onresize = function() {
            if (window.innerWidth < 768) {
                document.getElementById('mainSidebar').classList.remove('hidden');
            }
        };

        function openModal(id) {
            if(id === 'scheduleModal') prepareScheduleModal();
            document.getElementById(id).classList.remove('hidden');
            setTimeout(() => {
                document.getElementById(id).classList.remove('opacity-0');
                if(document.getElementById(id).querySelector('div')) document.getElementById(id).querySelector('div').classList.add('scale-100');
            }, 10);
        }
        function closeModal(id) {
             document.getElementById(id).classList.add('opacity-0');
             if(document.getElementById(id).querySelector('div')) document.getElementById(id).querySelector('div').classList.remove('scale-100');
             setTimeout(() => document.getElementById(id).classList.add('hidden'), 200);
        }
        
        function showConfirm(title, message, action) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            pendingConfirmAction = action;
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.onclick = function() {
                if (pendingConfirmAction) pendingConfirmAction();
                closeModal('confirmModal');
                pendingConfirmAction = null;
            };
            openModal('confirmModal');
        }
        
        function showAlert(title, message) {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = message;
            openModal('alertModal');
        }

        // --- FEATURE LOGIC ---
        function addClass() {
            const name = document.getElementById('newClassName').value;
            if(!name) return;
            const newClass = { id: Date.now().toString(), name, students: [], assignments: [], grades: {}, schedule: [1,3,5], materialLog: {}, homeworks: [], seating: {rows:5, cols:6, layout:{}} };
            appData.classes.push(newClass);
            appData.selectedClassId = newClass.id;
            saveData();
            document.getElementById('newClassName').value = '';
            closeModal('classModal');
            if(window.innerWidth < 768) toggleSidebar();
            renderClassList();
            renderClassView(newClass.id);
        }

        function askDeleteCurrentClass() {
            showConfirm("Delete Class?", "This will wipe all students and data in this class.", () => {
                appData.classes = appData.classes.filter(c => c.id !== appData.selectedClassId);
                appData.selectedClassId = null;
                saveData();
                renderClassList();
                document.getElementById('classDashboard').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            });
        }
        
        function askDeleteClass(id, e) {
            if(e) { e.stopPropagation(); }
            showConfirm("Delete Class?", "Are you sure?", () => {
                appData.classes = appData.classes.filter(c => String(c.id) !== String(id));
                if(String(appData.selectedClassId) === String(id)) {
                    appData.selectedClassId = null;
                    document.getElementById('classDashboard').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                }
                saveData();
                renderClassList();
            });
        }

        function renderClassList() {
            const el = document.getElementById('classList');
            el.innerHTML = '';
            appData.classes.forEach(c => {
                const isActive = c.id === appData.selectedClassId;
                const div = document.createElement('div');
                div.className = `p-3 mb-2 rounded-xl cursor-pointer flex justify-between items-center transition-all ${isActive ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-white hover:bg-slate-50 text-slate-600 border border-transparent hover:border-slate-200'}`;
                div.onclick = () => { appData.selectedClassId = c.id; saveData(); renderClassList(); renderClassView(c.id); if(window.innerWidth<768) toggleSidebar(); };
                
                // Icon Color logic: White if active, colorful if inactive
                const iconClass = isActive ? "text-white" : "text-indigo-500";
                
                div.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden flex-1">
                    <i class="ph ${isActive ? 'ph-folder-open-fill' : 'ph-folder'} text-xl ${iconClass}"></i>
                    <span class="font-semibold truncate text-sm">${c.name}</span>
                </div>
                <button onclick="askDeleteClass('${c.id}', event)" class="p-1.5 rounded-lg ${isActive ? 'hover:bg-indigo-500 text-indigo-200 hover:text-white' : 'hover:bg-red-50 hover:text-red-500 text-slate-300'} transition-colors">
                    <i class="ph ph-trash"></i>
                </button>
                `;
                el.appendChild(div);
            });
        }

        function renderClassView(id) {
            const cls = appData.classes.find(c => c.id === id);
            if(!cls) return;
            sortClassStudents(cls);
            
            document.getElementById('mobileHeaderTitle').innerText = cls.name;
            document.getElementById('mobileHeaderSubtitle').innerText = `${cls.students.length} Students`;
            document.getElementById('mobileHeaderSubtitle').classList.remove('hidden');
            document.getElementById('mobileHeaderActions').innerHTML = `<button onclick="askDeleteCurrentClass()" class="text-slate-400 hover:text-red-500 p-2"><i class="ph ph-trash text-xl"></i></button>`;

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('classDashboard').classList.remove('hidden');
            document.getElementById('classDashboard').classList.add('flex');
            document.getElementById('currentClassName').innerText = cls.name;
            document.getElementById('studentCountBadge').innerText = cls.students.length + ' Students';

            let currentTab = 'students';
            ['students', 'gradebook', 'tracker', 'homework', 'seating', 'summary'].forEach(t => {
                if(!document.getElementById('view' + t.charAt(0).toUpperCase() + t.slice(1)).classList.contains('hidden')) currentTab = t;
            });
            switchTab(currentTab);
        }

        function switchTab(tab) {
             const tabs = ['students', 'gradebook', 'tracker', 'homework', 'seating', 'summary'];
             
             const colors = {
                 'students': 'border-indigo-600 text-indigo-600',
                 'gradebook': 'border-emerald-500 text-emerald-600',
                 'tracker': 'border-rose-500 text-rose-600',
                 'homework': 'border-amber-500 text-amber-600',
                 'seating': 'border-violet-500 text-violet-600',
                 'summary': 'border-blue-500 text-blue-600'
             };

             tabs.forEach(t => {
                 const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                 btn.className = "px-4 py-3 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 transition-all flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent";
                 
                 document.getElementById('view' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('hidden');
             });
             
             const activeBtn = document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1));
             activeBtn.className = `px-4 py-3 text-sm font-bold rounded-lg bg-white shadow-sm transition-all flex items-center gap-2 whitespace-nowrap border-b-2 ${colors[tab]}`;

             const v = document.getElementById('view' + tab.charAt(0).toUpperCase() + tab.slice(1));
             v.classList.remove('hidden');
             if(tab !== 'students') v.classList.add('flex');
             
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             if(cls) {
                 if(tab === 'students') renderStudentList(cls);
                 if(tab === 'gradebook') renderGradebook(cls);
                 if(tab === 'tracker') { renderCalendar(); renderTrackerStats(cls); }
                 if(tab === 'homework') { 
                     if(currentHwTab === 'stream') renderHomeworkList(cls);
                     else renderHomeworkReport(cls);
                     renderHomeworkStats(cls);
                 }
                 if(tab === 'seating') renderSeatingPlan(cls);
                 if(tab === 'summary') renderSummary(cls);
             }
        }
        
        // --- SUMMARY TAB ---
        function toggleSummaryFullScreen() {
            const container = document.getElementById('summaryContainer');
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function renderSummary(cls) {
            const tbody = document.getElementById('summaryBody');
            tbody.innerHTML = '';
            
            // Calculate totals
            const summaryData = cls.students.map(s => {
                let hwPenalties = 0;
                cls.homeworks.forEach(hw => {
                    if (hw.penalties && hw.penalties[s.id]) hwPenalties += hw.penalties[s.id];
                });
                
                let matMissing = 0;
                Object.values(cls.materialLog).forEach(dayList => {
                    if (dayList.includes(s.id)) matMissing++;
                });
                
                return { 
                    ...s, 
                    hwPenalties, 
                    matMissing, 
                    total: hwPenalties + matMissing 
                };
            }).sort((a, b) => {
                // Sort by total infractions DESC, then Alphabetical ASC
                if (b.total !== a.total) return b.total - a.total;
                return a.name.localeCompare(b.name);
            });
            
            if (summaryData.length === 0) {
                document.getElementById('noSummaryMsg').classList.remove('hidden');
                return;
            }
            document.getElementById('noSummaryMsg').classList.add('hidden');
            
            summaryData.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors";
                
                // Content for cells
                let studentCell = `<div class="font-bold text-slate-700 text-lg">${s.name} <span class="text-indigo-400 text-sm ml-2">#${s.classNo}</span></div>`;
                let hwCell = `<span class="font-bold text-amber-600 text-xl">${s.hwPenalties > 0 ? s.hwPenalties : '<span class="text-slate-200">-</span>'}</span>`;
                let matCell = `<span class="font-bold text-rose-600 text-xl">${s.matMissing > 0 ? s.matMissing : '<span class="text-slate-200">-</span>'}</span>`;
                let totalCell = `<span class="bg-slate-800 text-white px-4 py-1.5 rounded-lg font-bold text-lg">${s.total}</span>`;
                
                // STAR STUDENT LOGIC (Total 0)
                if (s.total === 0) {
                     // Pick a cute icon randomly or just cycle
                     const icons = ['ph-trophy', 'ph-star', 'ph-medal', 'ph-smiley', 'ph-heart'];
                     const randomIcon = icons[s.name.length % icons.length]; // Deterministic based on name
                     const colors = ['text-yellow-500', 'text-orange-500', 'text-blue-500', 'text-pink-500'];
                     const randomColor = colors[s.name.length % colors.length];

                     hwCell = `<span class="text-slate-200 text-sm">-</span>`;
                     matCell = `<span class="text-slate-200 text-sm">-</span>`;
                     totalCell = `
                        <div class="flex items-center justify-end gap-2">
                             <span class="text-xs font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full uppercase tracking-wide">Perfect!</span>
                             <i class="ph ${randomIcon}-fill text-2xl ${randomColor}"></i>
                        </div>
                     `;
                     tr.className += " bg-yellow-50/30"; // Subtle highlight
                }

                tr.innerHTML = `
                    <td class="px-8 py-4">${studentCell}</td>
                    <td class="px-8 py-4 text-center">${hwCell}</td>
                    <td class="px-8 py-4 text-center">${matCell}</td>
                    <td class="px-8 py-4 text-right">${totalCell}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- STUDENTS ---
        function renderStudentList(cls) {
            const b = document.getElementById('studentListBody'); b.innerHTML = '';
            if(cls.students.length === 0) { document.getElementById('noStudentsMsg').classList.remove('hidden'); return; }
            document.getElementById('noStudentsMsg').classList.add('hidden');
            cls.students.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50/30 transition-colors group";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-indigo-900/70">${s.classLabel||'-'}</td>
                    <td class="px-6 py-4 font-bold text-slate-400 group-hover:text-indigo-500 transition-colors">${s.classNo||'-'}</td>
                    <td class="px-6 py-4 font-bold text-slate-700 text-base">${s.name}</td>
                    <td class="px-6 py-4 text-slate-400 font-mono text-xs">${s.studentId}</td>
                    <td class="px-6 py-4 text-right"><button onclick="askRemoveStudent('${s.id}')" class="text-slate-300 hover:text-rose-500 hover:bg-rose-50 p-2 rounded-lg transition-all"><i class="ph ph-trash text-lg"></i></button></td>
                `;
                b.appendChild(tr);
            });
        }
        function addStudent() {
             const name = document.getElementById('newStudentName').value;
             const clsName = document.getElementById('newStudentClass').value;
             const no = document.getElementById('newStudentNo').value;
             const id = document.getElementById('newStudentID').value;
             if(!name) return;
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             const s = { id: Date.now().toString(), name, classLabel: clsName, classNo: no, studentId: id || 'N/A' };
             cls.students.push(s);
             cls.grades[s.id] = {};
             sortClassStudents(cls);
             saveData();
             renderClassView(cls.id);
             closeModal('studentModal');
        }
        function askRemoveStudent(sid) {
            showConfirm("Delete Student?", "This action cannot be undone.", () => {
                const cls = appData.classes.find(c => c.id === appData.selectedClassId);
                cls.students = cls.students.filter(s => s.id !== sid);
                saveData();
                renderClassView(cls.id);
            });
        }
        function importStudentsFromText() {
            const txt = document.getElementById('importStudentText').value;
            if(!txt) return;
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            const lines = txt.split('\n');
            let added = 0;
            lines.forEach(l => {
                const c = l.split('\t');
                if(c.length >= 4) {
                     const name = c[3]?.trim();
                     if(name && name.toLowerCase() !== 'name') {
                         const s = { id: Date.now() + Math.random().toString(), name, classLabel: c[0], classNo: c[1], studentId: c[4]||'N/A' };
                         cls.students.push(s);
                         cls.grades[s.id] = {};
                         added++;
                     }
                }
            });
            if(added > 0) {
                sortClassStudents(cls);
                saveData();
                renderClassView(cls.id);
                closeModal('importStudentModal');
                showAlert("Success", `${added} students imported.`);
            }
        }

        // --- GRADEBOOK ---
        function renderGradebook(cls) {
            const tbody = document.getElementById('gradebookBody');
            const head = document.getElementById('gradebookHeaderRow');
            let hHTML = '<th class="px-4 py-3 bg-white border-b border-r border-slate-100 sticky left-0 z-20 w-56 min-w-[200px] text-slate-500">Student</th><th class="px-4 py-3 bg-emerald-50/50 border-b border-r border-emerald-100 w-24 text-emerald-700 text-center font-bold">Avg</th>';
            cls.assignments.forEach(a => {
                hHTML += `<th class="px-4 py-3 bg-white border-b border-r border-slate-100 min-w-[120px] font-bold text-slate-600 relative group"><div class="flex flex-col items-center"><span>${a.name}</span><span class="text-[10px] text-slate-400 font-normal">/${a.maxScore}</span><button onclick="askDeleteAssignment('${a.id}')" class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 text-rose-400 hover:text-rose-600 transition-opacity"><i class="ph ph-x-circle text-lg"></i></button></div></th>`;
            });
            head.innerHTML = hHTML;
            tbody.innerHTML = '';
            cls.students.forEach(s => {
                let total = 0, max = 0;
                let row = ``;
                cls.assignments.forEach(a => {
                    const score = cls.grades[s.id][a.id];
                    if(score !== undefined && score !== "") { total += parseFloat(score); max += parseFloat(a.maxScore); }
                    row += `<td class="px-2 py-2 border-b border-r border-slate-50 text-center"><input type="number" class="w-full text-center outline-none bg-transparent hover:bg-slate-50 focus:bg-emerald-50 focus:text-emerald-700 font-medium transition-colors rounded py-1" placeholder="-" value="${score||''}" onchange="updateGrade('${s.id}','${a.id}',this.value)"></td>`;
                });
                const avg = max === 0 ? '-' : Math.round((total/max)*100);
                const avgClass = avg >= 90 ? 'text-emerald-600 font-bold bg-emerald-50' : (avg < 60 && avg !== '-' ? 'text-rose-600 font-bold bg-rose-50' : 'text-slate-600');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-4 py-3 border-b border-r border-slate-100 sticky left-0 bg-white z-10"><div class="font-bold text-slate-700">${s.name}</div><div class="text-xs text-indigo-500 font-bold mt-0.5">${s.classLabel||''} <span class="text-slate-300">#</span>${s.classNo||''}</div></td><td class="px-4 py-3 border-b border-r border-emerald-100 text-center ${avgClass}">${avg}%</td>${row}`;
                tbody.appendChild(tr);
            });
        }
        function updateGrade(sid, aid, val) {
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            if(!cls.grades[sid]) cls.grades[sid] = {};
            cls.grades[sid][aid] = val;
            saveData();
            renderGradebook(cls);
        }
        function addAssignment() {
             const name = document.getElementById('assignName').value;
             const max = document.getElementById('assignMax').value;
             if(!name) return;
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             cls.assignments.push({id: Date.now().toString(), name, maxScore: max});
             saveData();
             closeModal('assignmentModal');
             renderGradebook(cls);
        }
        function askDeleteAssignment(aid) {
             showConfirm("Delete Grade?", "This will remove all scores for this item.", () => {
                const cls = appData.classes.find(c => c.id === appData.selectedClassId);
                cls.assignments = cls.assignments.filter(a => a.id !== aid);
                saveData();
                renderGradebook(cls);
            });
        }

        // --- MATERIALS ---
        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }
        function renderCalendar() {
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             if(!cls) return;
             const year = currentCalendarDate.getFullYear();
             const month = currentCalendarDate.getMonth();
             document.getElementById('calendarMonthLabel').innerText = new Date(year, month).toLocaleString('default', { month: 'short', year: 'numeric' });
             const grid = document.getElementById('calendarGrid');
             grid.innerHTML = '';
             const firstDay = new Date(year, month, 1).getDay();
             const daysInMonth = new Date(year, month+1, 0).getDate();
             
             for(let i=0; i<firstDay; i++) {
                 const d = document.createElement('div'); d.className = "h-14 md:h-24 bg-slate-50 border-r border-b border-slate-100"; grid.appendChild(d);
             }
             for(let d=1; d<=daysInMonth; d++) {
                 const dateString = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                 const dayOfWeek = new Date(year, month, d).getDay();
                 const isClassDay = cls.schedule.includes(dayOfWeek);
                 const logs = cls.materialLog[dateString] || [];
                 
                 const cell = document.createElement('div');
                 let clsName = "h-14 md:h-24 border-r border-b border-slate-100 p-1 flex flex-col items-center transition-all ";
                 if(isClassDay) {
                     clsName += "bg-indigo-50/50 cursor-pointer hover:bg-indigo-100/50 ";
                     cell.onclick = () => openDayLog(dateString);
                 } else {
                     clsName += "bg-white";
                 }
                 cell.className = clsName;
                 cell.innerHTML = `<span class="text-xs font-bold ${isClassDay ? 'text-indigo-900' : 'text-slate-300'}">${d}</span>`;
                 if(isClassDay && logs.length > 0) {
                     cell.innerHTML += `<div class="bg-rose-100 text-rose-600 rounded-md px-1.5 py-0.5 text-[10px] font-bold mt-1 shadow-sm border border-rose-200">${logs.length} <span class="hidden md:inline">Missing</span><span class="md:hidden">!</span></div>`;
                 }
                 grid.appendChild(cell);
             }
        }
        function openDayLog(d) {
            selectedLogDate = d;
            document.getElementById('logModalDateTitle').innerText = new Date(d).toLocaleDateString(undefined, {weekday:'long', month:'long', day:'numeric'});
            setMatView('list'); // Default to list
            openModal('dayLogModal');
            renderMatList(); // Helper to render list immediately
        }
        
        function renderMatList() {
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            const list = document.getElementById('logStudentList');
            list.innerHTML = '';
            const logs = cls.materialLog[selectedLogDate] || [];
            
            cls.students.forEach(s => {
                const isMiss = logs.includes(s.id);
                const div = document.createElement('div');
                div.className = `p-3 mb-2 border rounded-xl flex justify-between items-center cursor-pointer transition-all ${isMiss ? 'bg-rose-50 border-rose-200 shadow-sm' : 'bg-white border-slate-100 hover:border-indigo-200'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${isMiss ? 'bg-rose-200 text-rose-700' : 'bg-slate-100 text-slate-500'}">${s.classNo}</div>
                         <div class="${isMiss ? 'text-rose-900 font-bold' : 'text-slate-700 font-medium'}">${s.name}</div>
                    </div>
                    ${isMiss ? '<i class="ph ph-warning-circle text-rose-500 text-xl"></i>' : '<div class="w-5 h-5 rounded-full border-2 border-slate-200"></div>'}
                `;
                div.onclick = () => {
                    let newLogs = cls.materialLog[selectedLogDate] || [];
                    if(newLogs.includes(s.id)) newLogs = newLogs.filter(id => id !== s.id);
                    else newLogs.push(s.id);
                    cls.materialLog[selectedLogDate] = newLogs;
                    saveData();
                    renderMatList(); // Re-render list inside modal
                    // If seat view is open, re-render that too
                    if(activeMatView === 'seat') renderMaterialSeatingGrid();
                };
                list.appendChild(div);
            });
        }
        
        function setMatView(v) {
            activeMatView = v;
            const l = document.getElementById('logStudentList'); const s = document.getElementById('logSeatContainer');
            const btnL = document.getElementById('btnMatList'); const btnS = document.getElementById('btnMatSeat');
            
            if(v === 'list') {
                l.classList.remove('hidden'); s.classList.add('hidden');
                btnL.classList.add('bg-white', 'text-slate-800', 'shadow-sm'); btnL.classList.remove('text-slate-400');
                btnS.classList.remove('bg-white', 'text-slate-800', 'shadow-sm'); btnS.classList.add('text-slate-400');
                renderMatList();
            } else {
                l.classList.add('hidden'); s.classList.remove('hidden');
                btnS.classList.add('bg-white', 'text-slate-800', 'shadow-sm'); btnS.classList.remove('text-slate-400');
                btnL.classList.remove('bg-white', 'text-slate-800', 'shadow-sm'); btnL.classList.add('text-slate-400');
                renderMaterialSeatingGrid();
            }
        }
        
        function renderMaterialSeatingGrid() {
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             const grid = document.getElementById('logSeatGrid');
             const missingStudentIds = cls.materialLog[selectedLogDate] || [];
             grid.style.gridTemplateColumns = `repeat(${cls.seating.cols}, 60px)`;
             grid.innerHTML = '';
             for (let r = 0; r < cls.seating.rows; r++) {
                for (let c = 0; c < cls.seating.cols; c++) {
                    const key = `${r}-${c}`;
                    const val = cls.seating.layout[k];
                    const d = document.createElement('div');
                    if (val === 'walkway' || !val) {
                         d.className = "w-[60px] h-[60px] bg-transparent"; 
                    } else {
                        const student = cls.students.find(s => s.id === val);
                        if (student) {
                            const isMissing = missingStudentIds.includes(student.id);
                            d.className = `w-[60px] h-[60px] rounded-xl flex flex-col items-center justify-center text-[10px] p-1 text-center border-2 cursor-pointer transition-all shadow-sm ${isMissing ? 'bg-rose-100 border-rose-300 text-rose-800' : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-300'}`;
                            d.innerHTML = `<div class="font-bold opacity-50 text-[8px]">${student.classNo}</div><div class="font-bold truncate w-full">${student.name.split(' ')[0]}</div>`;
                            d.onclick = () => {
                                let logs = cls.materialLog[selectedLogDate] || [];
                                if(logs.includes(student.id)) logs = logs.filter(id => id !== student.id);
                                else logs.push(student.id);
                                cls.materialLog[selectedLogDate] = logs;
                                saveData();
                                renderMaterialSeatingGrid();
                            };
                        }
                    }
                    grid.appendChild(d);
                }
             }
        }
        
        function saveDayLog() { closeModal('dayLogModal'); renderCalendar(); renderTrackerStats(appData.classes.find(c=>c.id===appData.selectedClassId)); }
        function saveSchedule() { 
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            cls.schedule = Array.from(document.querySelectorAll('.schedule-day-check:checked')).map(cb => parseInt(cb.value));
            saveData(); closeModal('scheduleModal'); renderCalendar(); 
        }
        function prepareScheduleModal() {
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            if(!cls) return;
            document.querySelectorAll('.schedule-day-check').forEach(cb => cb.checked = cls.schedule.includes(parseInt(cb.value)));
        }
        
        function renderTrackerStats(cls) {
             const b = document.getElementById('trackerStatsBody'); b.innerHTML = '';
             const counts = {};
             cls.students.forEach(s => counts[s.id] = 0);
             Object.values(cls.materialLog).forEach(arr => arr.forEach(id => { if(counts[id]!==undefined) counts[id]++; }));
             const sorted = cls.students.map(s => ({...s, c: counts[s.id]})).sort((a,b) => b.c - a.c);
             let hasData = false;
             sorted.forEach(s => {
                 if(s.c === 0) return;
                 hasData = true;
                 const tr = document.createElement('tr');
                 tr.className = "hover:bg-rose-50/50 cursor-pointer group border-b border-slate-50 last:border-0";
                 tr.onclick = () => openMaterialDetails(s.id);
                 tr.innerHTML = `
                 <td class="py-3 px-2 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs flex items-center justify-center group-hover:bg-white group-hover:shadow-sm">${s.classNo}</div>
                    <div class="font-medium text-slate-700">${s.name}</div>
                 </td>
                 <td class="py-3 px-2 text-right"><span class="bg-rose-100 text-rose-600 px-2 py-1 rounded-lg text-xs font-bold">${s.c}</span></td>
                 `;
                 b.appendChild(tr);
             });
             if(hasData) document.getElementById('noTrackerStats').classList.add('hidden');
             else document.getElementById('noTrackerStats').classList.remove('hidden');
        }
        
        function openMaterialDetails(sid) {
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             const s = cls.students.find(st => st.id === sid);
             document.getElementById('materialStudentName').innerText = s.name;
             const l = document.getElementById('materialDatesList'); l.innerHTML = '';
             const dates = [];
             for(let [d, ids] of Object.entries(cls.materialLog)) { if(ids.includes(sid)) dates.push(d); }
             dates.sort().reverse().forEach(d => {
                 const div = document.createElement('div');
                 div.className = "flex justify-between p-2 bg-white border border-slate-100 rounded-lg";
                 div.innerHTML = `<span class="text-slate-600 font-medium">${new Date(d).toLocaleDateString()}</span><span class="text-rose-500 font-bold text-[10px] uppercase bg-rose-50 px-2 py-0.5 rounded">Missing</span>`;
                 l.appendChild(div);
             });
             if(dates.length===0) l.innerHTML = '<div class="text-center text-slate-400 italic py-2">No records.</div>';
             openModal('materialDetailsModal');
        }

        // --- HOMEWORK ---
        function addHomework() {
            const title = document.getElementById('hwTitle').value;
            const date = document.getElementById('hwDate').value;
            if(!title) return;
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            cls.homeworks.unshift({ id: Date.now().toString(), title: title, dueDate: date, completed: [], penalties: {} });
            saveData();
            closeModal('homeworkModal');
            renderHomeworkList(cls);
            renderHomeworkStats(cls);
        }
        function renderHomeworkList(cls) {
             const list = document.getElementById('homeworkList');
             list.innerHTML = '';
             if(cls.homeworks.length === 0) { document.getElementById('noHomeworkMsg').classList.remove('hidden'); return; }
             document.getElementById('noHomeworkMsg').classList.add('hidden');
             cls.homeworks.forEach(hw => {
                 const doneCount = hw.completed.length;
                 const d = document.createElement('div');
                 d.className = "p-4 bg-white border border-slate-200 rounded-2xl cursor-pointer hover:border-amber-400 hover:shadow-md transition-all mb-3 group";
                 d.innerHTML = `
                 <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-bold text-slate-800 text-sm">${hw.title}</h4>
                        <div class="text-xs text-slate-400 mt-1 flex items-center gap-1"><i class="ph ph-calendar"></i> ${hw.dueDate || 'No Date'}</div>
                    </div>
                    <div class="bg-slate-100 text-slate-500 px-2 py-1 rounded-lg text-xs font-bold group-hover:bg-amber-100 group-hover:text-amber-700 transition-colors">${doneCount} / ${cls.students.length}</div>
                 </div>
                 <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div class="bg-amber-500 h-full" style="width: ${(doneCount/cls.students.length)*100}%"></div></div>
                 `;
                 d.onclick = () => openHomeworkCheck(hw.id);
                 list.appendChild(d);
             });
        }
        function switchHwSubTab(tab) {
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             if(tab === 'stream') {
                 document.getElementById('hwStreamView').classList.remove('hidden');
                 document.getElementById('hwReportView').classList.add('hidden');
                 document.getElementById('hwSubTabStream').classList.replace('border-transparent','border-indigo-600');
                 document.getElementById('hwSubTabStream').classList.replace('text-indigo-600','text-indigo-600'); // Ensure active color
                 document.getElementById('hwSubTabReport').classList.replace('border-indigo-600','border-transparent');
             } else {
                 document.getElementById('hwStreamView').classList.add('hidden');
                 document.getElementById('hwReportView').classList.remove('hidden');
                 renderHomeworkReport(cls);
             }
        }
        function renderHomeworkReport(cls) {
             const head = document.getElementById('hwReportHeader');
             const body = document.getElementById('hwReportBody');
             let h = '<th class="px-4 py-3 border-b border-slate-100 bg-slate-50 sticky left-0 z-10 w-48 text-slate-500 text-xs uppercase font-bold">Student</th>';
             cls.homeworks.forEach(hw => h += `<th class="px-4 py-3 border-b border-slate-100 text-center text-xs font-bold text-slate-500 truncate max-w-[100px]">${hw.title}</th>`);
             h += '<th class="px-4 py-3 border-b border-slate-100 text-center w-24 text-rose-500 text-xs uppercase font-bold sticky right-0 bg-slate-50 z-10">Penalties</th>';
             head.innerHTML = `<tr>${h}</tr>`;
             
             body.innerHTML = '';
             cls.students.forEach(s => {
                 let total = 0;
                 let r = `<td class="px-4 py-3 border-b border-slate-100 sticky left-0 bg-white z-10 font-bold text-slate-700">${s.name} <span class="text-indigo-300 ml-1 text-xs">#${s.classNo}</span></td>`;
                 cls.homeworks.forEach(hw => {
                     const p = (hw.penalties || {})[s.id] || 0;
                     total += parseFloat(p);
                     const isDone = hw.completed.includes(s.id);
                     let cellContent = isDone ? '<i class="ph ph-check text-green-500"></i>' : '<span class="w-2 h-2 bg-slate-200 rounded-full inline-block"></span>';
                     if(p > 0) cellContent = `<span class="text-rose-600 font-bold bg-rose-50 px-2 py-0.5 rounded text-xs">-${p}</span>`;
                     // Editable on click? Let's make it a number input for penalty like before
                     r += `<td class="px-2 py-2 border-b border-slate-100 text-center"><input type="number" class="w-8 text-center bg-transparent outline-none text-sm ${p>0?'text-rose-600 font-bold':''}" value="${p}" onchange="updateHomeworkPenalty('${s.id}','${hw.id}',this.value)"></td>`;
                 });
                 r += `<td class="px-4 py-3 border-b border-slate-100 text-center font-bold text-rose-600 bg-slate-50/50 sticky right-0 z-10">${total}</td>`;
                 const tr = document.createElement('tr'); tr.innerHTML = r; body.appendChild(tr);
             });
        }
        function updateHomeworkPenalty(sid, hid, val) {
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             const hw = cls.homeworks.find(h => h.id === hid);
             if(!hw.penalties) hw.penalties = {};
             hw.penalties[sid] = parseFloat(val);
             saveData();
             renderHomeworkStats(cls);
        }
        function renderHomeworkStats(cls) {
            const tbody = document.getElementById('homeworkStatsBody');
            tbody.innerHTML = '';
            const stats = cls.students.map(s => {
                let totalPenalty = 0;
                cls.homeworks.forEach(hw => { if(hw.penalties && hw.penalties[s.id]) totalPenalty += hw.penalties[s.id]; });
                return { ...s, totalPenalty };
            }).sort((a, b) => b.totalPenalty - a.totalPenalty);
            
            let hasP = false;
            stats.forEach(s => {
                if(s.totalPenalty === 0) return;
                hasP = true;
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-50 last:border-0";
                tr.innerHTML = `<td class="py-3 px-2 text-slate-700 font-medium">${s.name}</td><td class="py-3 px-2 text-right"><span class="bg-red-100 text-red-700 px-2 py-1 rounded-lg text-xs font-bold">-${s.totalPenalty}</span></td>`;
                tbody.appendChild(tr);
            });
            if(hasP) document.getElementById('noHomeworkStats').classList.add('hidden');
            else document.getElementById('noHomeworkStats').classList.remove('hidden');
        }
        
        function flagAllUnticked() {
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            const hw = cls.homeworks.find(h => h.id === selectedHomeworkId);
            
            if(!hw.penalties) hw.penalties = {};

            let changesMade = false;
            cls.students.forEach(s => {
                if (!hw.completed.includes(s.id)) {
                    const current = hw.penalties[s.id] || 0;
                    hw.penalties[s.id] = current + 1;
                    changesMade = true;
                }
            });

            if (changesMade) {
                saveData();
                if (activeHwView === 'list') openHomeworkCheck(selectedHomeworkId);
                else renderHomeworkSeatingGrid();
                renderHomeworkStats(cls);
                if(currentHwTab === 'report') renderHomeworkReport(cls);
            }
        }

        // Homework Check Modal Logic
        function openHomeworkCheck(hid) {
             selectedHomeworkId = hid;
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             const hw = cls.homeworks.find(h => h.id === hid);
             document.getElementById('hwCheckTitle').innerText = hw.title;
             
             // Initial render based on active view
             if (activeHwView === 'list') renderHwList(cls, hw);
             else renderHomeworkSeatingGrid();
             
             openModal('homeworkCheckModal');
        }
        
        function renderHwList(cls, hw) {
            const list = document.getElementById('hwStudentList');
            list.innerHTML = '';
            // Update toggle button text
            const allDone = cls.students.length > 0 && cls.students.every(s => hw.completed.includes(s.id));
            document.getElementById('markAllText').innerText = allDone ? "Unmark All" : "Mark All Done";
            document.getElementById('markAllIcon').className = allDone ? "ph ph-x" : "ph ph-checks";
            
            cls.students.forEach(s => {
                 const isDone = hw.completed.includes(s.id);
                 const p = (hw.penalties||{})[s.id];
                 const d = document.createElement('div');
                 d.className = `p-3 mb-2 rounded-xl border flex justify-between items-center cursor-pointer transition-all ${isDone ? 'bg-green-50 border-green-200 shadow-sm' : 'bg-white border-slate-100 hover:border-indigo-200'}`;
                 d.innerHTML = `
                    <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${isDone ? 'bg-green-200 text-green-700' : 'bg-slate-100 text-slate-500'}">${s.classNo}</div>
                         <div>
                            <div class="${isDone ? 'text-green-900 font-bold' : 'text-slate-700 font-medium'}">${s.name}</div>
                            ${p ? `<div class="text-[10px] text-red-600 bg-red-50 inline-block px-1 rounded font-bold">-${p} pts</div>` : ''}
                         </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openPenaltyRecord('${s.id}', event)" class="p-2 text-red-300 hover:text-red-500 hover:bg-red-50 rounded-lg"><i class="ph ph-flag-fill"></i></button>
                        <div class="w-6 h-6 rounded-full border-2 ${isDone ? 'border-green-500 bg-green-500 text-white' : 'border-slate-200'} flex items-center justify-center"><i class="ph ph-check text-xs ${isDone?'':'hidden'}"></i></div>
                    </div>
                 `;
                 d.onclick = (e) => {
                     // If clicking the row (not the flag button)
                     if(e.target.closest('button')) return; 
                     toggleHomeworkCompletion(s.id);
                 };
                 list.appendChild(d);
            });
        }

        function toggleHomeworkCompletion(sid) {
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            const hw = cls.homeworks.find(h => h.id === selectedHomeworkId);
            if(hw.completed.includes(sid)) hw.completed = hw.completed.filter(id => id !== sid);
            else hw.completed.push(sid);
            saveData();
            if(activeHwView === 'list') renderHwList(cls, hw);
            else renderHomeworkSeatingGrid();
            renderHomeworkStats(cls);
        }

        function markAllHomeworkDone() {
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             const hw = cls.homeworks.find(h => h.id === selectedHomeworkId);
             const allDone = cls.students.length > 0 && cls.students.every(s => hw.completed.includes(s.id));
             if(allDone) hw.completed = [];
             else hw.completed = cls.students.map(s => s.id);
             saveData();
             if(activeHwView === 'list') renderHwList(cls, hw);
             else { renderHomeworkSeatingGrid(); }
             renderHomeworkStats(cls);
        }
        
        function setHwView(v) {
            activeHwView = v;
            const l = document.getElementById('hwStudentList'); const s = document.getElementById('hwSeatContainer');
            const btnL = document.getElementById('btnHwList'); const btnS = document.getElementById('btnHwSeat');
            if(v === 'list') { 
                l.classList.remove('hidden'); s.classList.add('hidden'); 
                btnL.className = "px-4 py-1.5 text-xs font-bold rounded-lg shadow-sm bg-white text-slate-800";
                btnS.className = "px-4 py-1.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700";
                const cls = appData.classes.find(c => c.id === appData.selectedClassId);
                const hw = cls.homeworks.find(h => h.id === selectedHomeworkId);
                renderHwList(cls, hw);
            } else { 
                l.classList.add('hidden'); s.classList.remove('hidden'); 
                btnS.className = "px-4 py-1.5 text-xs font-bold rounded-lg shadow-sm bg-white text-slate-800";
                btnL.className = "px-4 py-1.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700";
                renderHomeworkSeatingGrid(); 
            }
        }
        
        function renderHomeworkSeatingGrid() {
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            const hw = cls.homeworks.find(h => h.id === selectedHomeworkId);
            const g = document.getElementById('hwSeatGrid');
            g.style.gridTemplateColumns = `repeat(${cls.seating.cols}, 60px)`;
            g.innerHTML = '';
            for(let r=0; r<cls.seating.rows; r++) {
                 for(let c=0; c<cls.seating.cols; c++) {
                     const k = `${r}-${c}`;
                     const val = cls.seating.layout[k];
                     const d = document.createElement('div');
                     if(!val || val === 'walkway') {
                         d.className = "w-[60px] h-[60px] border border-slate-100 rounded-xl bg-slate-50/50";
                     } else {
                         const st = cls.students.find(s => s.id === val);
                         if(st) {
                             const isDone = hw.completed.includes(st.id);
                             const p = (hw.penalties||{})[st.id];
                             let border = isDone ? 'border-green-400 bg-green-50' : 'border-slate-200 bg-white';
                             if(p) border = 'border-red-400 bg-red-50';
                             
                             d.className = `w-[60px] h-[60px] border-2 rounded-xl flex flex-col items-center justify-center text-xs p-1 text-center cursor-pointer relative shadow-sm ${border}`;
                             d.innerHTML = `
                                <div class="font-bold opacity-50 text-[8px]">${st.classNo}</div>
                                <div class="font-bold truncate w-full leading-tight text-slate-700">${st.name.split(' ')[0]}</div>
                                ${isDone ? '<div class="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full"></div>' : ''}
                                ${p ? '<div class="absolute top-1 left-1 text-[8px] text-red-600 font-bold">!</div>' : ''}
                             `;
                             d.onclick = () => toggleHomeworkCompletion(st.id);
                         }
                     }
                     g.appendChild(d);
                 }
            }
        }
        
        function openPenaltyRecord(sid, e) {
            if(e) e.stopPropagation();
            selectedPenaltyStudentId = sid;
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            const hw = cls.homeworks.find(h => h.id === selectedHomeworkId);
            const s = cls.students.find(st => st.id === sid);
            
            tempPenaltyCount = (hw.penalties || {})[sid] || 0;
            document.getElementById('penaltyStudentName').innerText = s.name;
            document.getElementById('penaltyHomeworkTitle').innerText = hw.title;
            document.getElementById('penaltyCountDisplay').innerText = tempPenaltyCount;
            openModal('penaltyDetailModal');
        }
        function adjustPenaltyCount(n) {
             tempPenaltyCount += n;
             if(tempPenaltyCount < 0) tempPenaltyCount = 0;
             document.getElementById('penaltyCountDisplay').innerText = tempPenaltyCount;
        }
        function savePenaltyDetail() {
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             const hw = cls.homeworks.find(h => h.id === selectedHomeworkId);
             if(!hw.penalties) hw.penalties = {};
             if(tempPenaltyCount > 0) hw.penalties[selectedPenaltyStudentId] = tempPenaltyCount;
             else delete hw.penalties[selectedPenaltyStudentId];
             saveData();
             closeModal('penaltyDetailModal');
             if(activeHwView === 'list') renderHwList(cls, hw);
             else renderHomeworkSeatingGrid();
             renderHomeworkStats(cls);
        }
        function askDeleteHomework() {
            showConfirm("Delete Homework?", "Permanently remove this task?", () => {
                const cls = appData.classes.find(c => c.id === appData.selectedClassId);
                cls.homeworks = cls.homeworks.filter(h => h.id !== selectedHomeworkId);
                saveData(); closeModal('homeworkCheckModal'); renderHomeworkList(cls);
            });
        }


        // --- SEATING ---
        function updateSeatingGrid() {
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             cls.seating.rows = document.getElementById('seatRows').value;
             cls.seating.cols = document.getElementById('seatCols').value;
             saveData();
             renderSeatingPlan(cls);
        }
        
        function toggleEditSeating() {
             isSeatingEditMode = !isSeatingEditMode;
             const btn = document.getElementById('btnEditSeat');
             if(isSeatingEditMode) {
                 btn.classList.add('bg-violet-600', 'text-white', 'border-transparent'); btn.classList.remove('bg-white', 'text-slate-700', 'border-slate-200');
                 btn.innerHTML = '<i class="ph ph-check"></i> Done';
             } else {
                 btn.classList.remove('bg-violet-600', 'text-white', 'border-transparent'); btn.classList.add('bg-white', 'text-slate-700', 'border-slate-200');
                 btn.innerHTML = '<i class="ph ph-pencil-simple"></i> Edit';
             }
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             renderSeatingPlan(cls);
        }
        
        function renderSeatingPlan(cls) {
             const g = document.getElementById('seatingGrid');
             g.style.gridTemplateColumns = `repeat(${cls.seating.cols}, 80px)`;
             g.innerHTML = '';
             for(let r=0; r<cls.seating.rows; r++) {
                 for(let c=0; c<cls.seating.cols; c++) {
                     const k = `${r}-${c}`;
                     const val = cls.seating.layout[k];
                     const d = document.createElement('div');
                     d.className = "w-20 h-20 border-2 rounded-2xl flex flex-col items-center justify-center p-1 text-xs text-center transition-all ";
                     
                     if(val === 'walkway') {
                         d.className += isSeatingEditMode ? "border-dashed border-slate-300 bg-slate-50 cursor-pointer" : "border-transparent bg-transparent";
                     } else if(val) {
                         const s = cls.students.find(st => st.id === val);
                         d.className += "bg-white border-violet-100 shadow-sm text-violet-900 cursor-pointer hover:border-violet-300 hover:shadow-md";
                         d.innerHTML = s ? `<div class="font-bold text-violet-400 text-[10px] mb-1">${s.classNo}</div><div class="truncate w-full font-bold leading-tight">${s.name.split(' ')[0]}</div>` : '?';
                     } else {
                         // Empty
                         d.className += "bg-slate-50 border-slate-100";
                         if(isSeatingEditMode) {
                             d.className += " hover:bg-white hover:border-slate-300 cursor-pointer";
                             d.innerHTML = '<i class="ph ph-plus text-slate-300 text-xl"></i>';
                             d.onclick = () => openSeatAssign(r, c);
                         }
                     }
                     
                     if (isSeatingEditMode && (val === 'walkway' || val)) {
                         d.onclick = () => openSeatAssign(r, c);
                     }
                     g.appendChild(d);
                 }
             }
        }
        
        function openSeatAssign(r, c) {
             selectedSeatCoords = {r,c};
             const cls = appData.classes.find(c => c.id === appData.selectedClassId);
             const l = document.getElementById('seatStudentList'); l.innerHTML = '';
             
             // List all students
             cls.students.forEach(s => {
                 const isSeated = Object.values(cls.seating.layout).includes(s.id);
                 const d = document.createElement('div');
                 d.className = `p-3 border rounded-xl cursor-pointer mb-2 flex justify-between ${isSeated ? 'bg-slate-50 text-slate-400 border-slate-100' : 'bg-white border-slate-200 hover:border-violet-300 shadow-sm'}`;
                 d.innerHTML = `<span class="font-bold">${s.classNo}</span> <span>${s.name}</span>`;
                 if(!isSeated) d.onclick = () => assignSeatValue(s.id);
                 l.appendChild(d);
             });
             openModal('seatAssignModal');
        }
        
        function assignSeatValue(val) {
            const cls = appData.classes.find(c => c.id === appData.selectedClassId);
            const k = `${selectedSeatCoords.r}-${selectedSeatCoords.c}`;
            
            if (val === null) {
                // Clearing a seat
                delete cls.seating.layout[k];
            } else {
                // If the new value is NOT 'walkway', we must check if this student (ID) is already seated elsewhere
                // and remove them from that old spot.
                // If val IS 'walkway', we skip this check so we can have multiple walkways.
                if (val !== 'walkway') {
                    for(let key in cls.seating.layout) {
                        if(cls.seating.layout[key] === val) {
                            delete cls.seating.layout[key];
                        }
                    }
                }
                // Assign new value to this coordinate
                cls.seating.layout[k] = val;
            }
            
            saveData();
            renderSeatingPlan(cls);
            closeModal('seatAssignModal');
        }

        // --- DEMO DATA ---
        function loadDemoData() {
             const demoId = Date.now().toString();
             const students = [
                { id: demoId + "_s1", name: "Alice Johnson", classLabel: "1A", classNo: "1", studentId: "2024001" },
                { id: demoId + "_s2", name: "Bob Smith", classLabel: "1A", classNo: "2", studentId: "2024002" },
                { id: demoId + "_s3", name: "Charlie Brown", classLabel: "1A", classNo: "3", studentId: "2024003" },
                { id: demoId + "_s4", name: "Daisy Miller", classLabel: "1A", classNo: "4", studentId: "2024004" },
                { id: demoId + "_s5", name: "Ethan Hunt", classLabel: "1A", classNo: "5", studentId: "2024005" },
                { id: demoId + "_s6", name: "Fiona Gallagher", classLabel: "1B", classNo: "6", studentId: "2024006" },
                { id: demoId + "_s7", name: "George Martin", classLabel: "1B", classNo: "7", studentId: "2024007" },
                { id: demoId + "_s8", name: "Hannah Lee", classLabel: "1B", classNo: "8", studentId: "2024008" },
                { id: demoId + "_s9", name: "Ian Wright", classLabel: "1B", classNo: "9", studentId: "2024009" },
                { id: demoId + "_s10", name: "Julia Roberts", classLabel: "1B", classNo: "10", studentId: "2024010" }
             ];
             const grades = {};
             students.forEach(s => grades[s.id] = {});
             const homeworks = [{
                id: demoId + "_hw1", title: "Read Chapter 1", dueDate: new Date().toISOString().split('T')[0],
                completed: [students[0].id, students[1].id, students[2].id], penalties: { [students[3].id]: 1 }
             }];
             const layout = {};
             // Simple grid seating for demo
             students.forEach((s, i) => {
                 const r = Math.floor(i / 6);
                 const c = i % 6;
                 layout[`${r}-${c}`] = s.id;
             });

             const demoClass = {
                id: demoId, name: "Demo Class 101", students, assignments: [], grades, schedule: [1,3,5], materialLog: {}, homeworks, seating: {rows:5, cols:6, layout}
             };
             appData.classes.push(demoClass);
             appData.selectedClassId = demoId;
             saveData();
             renderClassList();
             renderClassView(demoId);
        }

    </script>
</body>
</html>
